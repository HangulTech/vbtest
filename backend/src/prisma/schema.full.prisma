generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////
// ENUMS
//////////////////////

enum UserRole {
  SUPER_ADMIN
  SCHOOL_ADMIN
  TEACHER
  STUDENT
  PARENT
  DRIVER
  OPEN_USER
}

enum PersonType {
  STUDENT
  TEACHER
  STAFF
  SECURITY
  DRIVER
  HELPER
}

enum AttendanceStatus {
  PRESENT
  ABSENT
}

//////////////////////
// TENANT
//////////////////////

model Tenant {
  id       String  @id @default(uuid())
  name     String
  isActive Boolean @default(true)

  users         User[]
  persons       Person[]
  students      Student[]
  schoolProfile SchoolProfile?

  vehicles Vehicle[]
  routes   Route[]
  devices  Device[]

  createdAt DateTime @default(now())
}

//////////////////////
// USERS / AUTH
//////////////////////

model User {
  id       String   @id @default(uuid())
  phone    String?  @unique
  email    String?  @unique
  password String?
  role     UserRole

  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  persons       Person[]
  parentProfile Parent?
  driverProfile DriverProfile?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////
// SCHOOL
//////////////////////

model SchoolProfile {
  id       String @id @default(uuid())
  tenantId String @unique
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  schoolCode String @unique
  address    String?
  phone      String?
  email      String?

  createdAt DateTime @default(now())
}

//////////////////////
// PERSON (ATTENDANCE IDENTITY)
//////////////////////

model Person {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  type    PersonType
  refId   String?
  rfidTag String @unique

  student Student?

  attendance    Attendance[]
  events        MovementEvent[]
  notifications Notification[]

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
}

//////////////////////
// STUDENT
//////////////////////

model Student {
  id         String   @id @default(uuid())
  rmfId      String
  fullName   String
  rollNumber String?
  tenantId   String
  personId   String   @unique

  tenant Tenant @relation(fields: [tenantId], references: [id])
  person Person @relation(fields: [personId], references: [id])

  notifications Notification[]
  parentLinks   ParentStudent[]
  routes        StudentRoute[]
  boardingLogs  BoardingLog[]

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
}

//////////////////////
// PARENTS
//////////////////////

model Parent {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  students  ParentStudent[]
  createdAt DateTime @default(now())
}

model ParentStudent {
  id        String @id @default(uuid())
  parentId  String
  studentId String

  parent  Parent  @relation(fields: [parentId], references: [id])
  student Student @relation(fields: [studentId], references: [id])

  @@unique([parentId, studentId])
}

//////////////////////
// TRANSPORT
//////////////////////

model DriverProfile {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  assignments DriverAssignment[]
  trips       Trip[]

  licenseNo String?
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
}

model Vehicle {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  vehicleNo String
  type      String
  capacity  Int?

  drivers DriverAssignment[]
  routes  Route[]

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
}

model DriverAssignment {
  id        String @id @default(uuid())
  driverId  String
  vehicleId String

  driver  DriverProfile @relation(fields: [driverId], references: [id])
  vehicle Vehicle       @relation(fields: [vehicleId], references: [id])

  assignedAt DateTime @default(now())

  @@unique([driverId, vehicleId])
}

model Route {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id])

  name      String
  direction String

  stops RouteStop[]
  trips Trip[]

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
}

model RouteStop {
  id      String @id @default(uuid())
  routeId String
  route   Route  @relation(fields: [routeId], references: [id])

  name      String
  latitude  Float
  longitude Float
  stopOrder Int

  students StudentRoute[]

  createdAt DateTime @default(now())

  @@unique([routeId, stopOrder])
}

model StudentRoute {
  id        String @id @default(uuid())
  studentId String
  stopId    String

  student Student   @relation(fields: [studentId], references: [id])
  stop    RouteStop @relation(fields: [stopId], references: [id])

  @@unique([studentId, stopId])
}

model Trip {
  id      String @id @default(uuid())
  routeId String
  route   Route @relation(fields: [routeId], references: [id])

  driverId String
  driver   DriverProfile @relation(fields: [driverId], references: [id])

  startedAt DateTime?
  endedAt   DateTime?

  currentStopIndex Int?

  boardingLogs BoardingLog[]

  createdAt DateTime @default(now())
}

model BoardingLog {
  id        String @id @default(uuid())
  tripId    String
  studentId String

  trip    Trip    @relation(fields: [tripId], references: [id])
  student Student @relation(fields: [studentId], references: [id])

  eventType String
  latitude  Float?
  longitude Float?
  timestamp DateTime @default(now())

  @@index([studentId])
}

//////////////////////
// ATTENDANCE
//////////////////////

model Attendance {
  id       String           @id @default(uuid())
  personId String
  date     DateTime
  status   AttendanceStatus
  source   String

  person Person @relation(fields: [personId], references: [id])

  createdAt DateTime @default(now())

  @@unique([personId, date])
}

model MovementEvent {
  id        String   @id @default(uuid())
  personId  String
  eventType String
  source    String
  location  String?
  timestamp DateTime @default(now())

  person Person @relation(fields: [personId], references: [id])

  @@index([personId, timestamp])
}

//////////////////////
// DEVICES
//////////////////////

model Device {
  id        String @id @default(uuid())
  deviceId  String @unique
  secretKey String
  type      String

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  location String?
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
}

//////////////////////
// NOTIFICATIONS
//////////////////////

model Notification {
  id        String   @id @default(uuid())
  type      String
  title     String
  message   String

  studentId String?
  personId  String?

  metadata  Json?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  student   Student? @relation(fields: [studentId], references: [id])
  person    Person?  @relation(fields: [personId], references: [id])
}
