generator client {
  provider = "prisma-client-js"
}


datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////
// ENUMS
//////////////////////

enum UserRole {
  SUPER_ADMIN
  SCHOOL_ADMIN
  TEACHER
  STUDENT
  PARENT
  DRIVER
  OPEN_USER
}

enum PersonType {
  STUDENT
  TEACHER
  STAFF
  SECURITY
  DRIVER
  HELPER
}

enum AttendanceStatus {
  PRESENT
  ABSENT
}

//////////////////////
// CORE TENANT
//////////////////////

model Tenant {
  id       String  @id @default(uuid())
  name     String
  isActive Boolean @default(true)

  users         User[]
  persons       Person[]
  students      Student[]
  schoolProfile SchoolProfile?

  vehicles Vehicle[]
  routes   Route[]

  createdAt DateTime @default(now())
  Device    Device[]
}

//////////////////////
// AUTH / USERS
//////////////////////

model User {
  id       String   @id @default(uuid())
  phone    String?  @unique
  email    String?  @unique
  password String?
  role     UserRole

  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  persons       Person[]
  parentProfile Parent?
  driverProfile DriverProfile?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////
// SCHOOL
//////////////////////

model SchoolProfile {
  id       String @id @default(uuid())
  tenantId String @unique
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  schoolCode String  @unique
  address    String?
  phone      String?
  email      String?

  createdAt DateTime @default(now())
}

//////////////////////
// PERSON (ATTENDANCE IDENTITY)
//////////////////////

model Person {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  type    PersonType
  refId   String? // soft reference (DriverProfile, Helper, etc.)
  rfidTag String     @unique

  student Student?

  attendance Attendance[]
  events     MovementEvent[]

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
}

//////////////////////
// STUDENTS
//////////////////////

model Student {
  id         String  @id @default(uuid())
  rmfId      String  @unique
  fullName   String
  rollNumber String?

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  personId String? @unique
  person   Person? @relation(fields: [personId], references: [id])

  parents      ParentStudent[]
  routes       StudentRoute[]
  boardingLogs BoardingLog[]

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
}

//////////////////////
// PARENTS
//////////////////////

model Parent {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  students  ParentStudent[]
  createdAt DateTime        @default(now())
}

model ParentStudent {
  id        String @id @default(uuid())
  parentId  String
  studentId String

  parent  Parent  @relation(fields: [parentId], references: [id])
  student Student @relation(fields: [studentId], references: [id])

  @@unique([parentId, studentId])
}

//////////////////////
// TRANSPORT
//////////////////////

model DriverProfile {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  assignments DriverAssignment[]
  trips       Trip[]

  licenseNo String?
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
}

model Vehicle {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  vehicleNo String
  type      String // BUS / CAB
  capacity  Int?

  drivers DriverAssignment[]
  routes  Route[]

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
}

model DriverAssignment {
  id        String @id @default(uuid())
  driverId  String
  vehicleId String

  driver  DriverProfile @relation(fields: [driverId], references: [id])
  vehicle Vehicle       @relation(fields: [vehicleId], references: [id])

  assignedAt DateTime @default(now())

  @@unique([driverId, vehicleId])
}

model Route {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id])

  name      String
  direction String // MORNING / EVENING

  stops RouteStop[]
  trips Trip[]

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
}

model RouteStop {
  id      String @id @default(uuid())
  routeId String
  route   Route  @relation(fields: [routeId], references: [id])

  name      String
  latitude  Float
  longitude Float
  stopOrder Int

  students StudentRoute[]

  createdAt DateTime @default(now())

  @@unique([routeId, stopOrder])
}

model StudentRoute {
  id        String @id @default(uuid())
  studentId String
  stopId    String

  student Student   @relation(fields: [studentId], references: [id])
  stop    RouteStop @relation(fields: [stopId], references: [id])

  @@unique([studentId, stopId])
}

model Trip {
  id      String @id @default(uuid())
  routeId String
  route   Route  @relation(fields: [routeId], references: [id])

  driverId String
  driver   DriverProfile @relation(fields: [driverId], references: [id])

  startedAt DateTime?
  endedAt   DateTime?

  currentStopIndex Int?

  boardingLogs BoardingLog[]

  createdAt DateTime @default(now())
}

model BoardingLog {
  id        String @id @default(uuid())
  tripId    String
  studentId String

  trip    Trip    @relation(fields: [tripId], references: [id])
  student Student @relation(fields: [studentId], references: [id])

  eventType String // BOARD / DROP
  latitude  Float?
  longitude Float?
  timestamp DateTime @default(now())

  @@index([studentId])
}

//////////////////////
// ATTENDANCE & EVENTS
//////////////////////

model Attendance {
  id       String           @id @default(uuid())
  personId String
  date     DateTime
  status   AttendanceStatus
  source   String // EVENT / MANUAL

  person Person @relation(fields: [personId], references: [id])

  createdAt DateTime @default(now())

  @@unique([personId, date])
}

model MovementEvent {
  id        String   @id @default(uuid())
  personId  String
  eventType String // ENTER_SCHOOL, EXIT_SCHOOL, BOARD_BUS, DROP_BUS
  source    String // SCHOOL_RFID, BUS_RFID
  location  String?
  timestamp DateTime @default(now())

  person Person @relation(fields: [personId], references: [id])

  @@index([personId, timestamp])
}

//////////////////////
// DEVICES (RFID / BUS)
//////////////////////

model Device {
  id        String @id @default(uuid())
  deviceId  String @unique
  secretKey String
  type      String // SCHOOL_RFID / BUS_RFID

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  location String?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
}
