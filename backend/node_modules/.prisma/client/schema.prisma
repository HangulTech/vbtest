generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  SCHOOL_ADMIN
  TEACHER
  STUDENT
  PARENT
  DRIVER
  OPEN_USER
}

model Tenant {
  id       String  @id @default(uuid())
  name     String
  isActive Boolean @default(true)

  users         User[]
  schoolProfile SchoolProfile?
  students      Student[]

  vehicles Vehicle[]
  routes   Route[]

  createdAt DateTime @default(now())
  Person    Person[]
}

model User {
  id       String   @id @default(uuid())
  phone    String?  @unique
  email    String?  @unique
  password String?
  role     UserRole
  tenantId String?
  tenant   Tenant?  @relation(fields: [tenantId], references: [id])

  parentProfile Parent?
  driverProfile DriverProfile?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Person    Person[]
}

model SchoolProfile {
  id       String @id @default(uuid())
  tenantId String @unique
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  schoolCode String  @unique
  address    String?
  phone      String?
  email      String?

  createdAt DateTime @default(now())
}

model Student {
  id         String  @id @default(uuid())
  rmfId      String  @unique
  fullName   String
  rollNumber String?
  tenantId   String
  tenant     Tenant  @relation(fields: [tenantId], references: [id])

  person       Person?         @relation(fields: [personId], references: [id])
  parents      ParentStudent[]
  routes       StudentRoute[]
  boardingLogs BoardingLog[]

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  personId  String?
}

model Parent {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  students  ParentStudent[]
  createdAt DateTime        @default(now())
}

model ParentStudent {
  id        String @id @default(uuid())
  parentId  String
  studentId String

  parent  Parent  @relation(fields: [parentId], references: [id])
  student Student @relation(fields: [studentId], references: [id])

  @@unique([parentId, studentId])
}

model DriverProfile {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  assignments DriverAssignment[]
  trips       Trip[]

  licenseNo String?
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
}

model Vehicle {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  vehicleNo String
  type      String // BUS / CAB
  capacity  Int?

  drivers DriverAssignment[]
  routes  Route[]

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
}

model DriverAssignment {
  id        String @id @default(uuid())
  driverId  String
  vehicleId String

  driver  DriverProfile @relation(fields: [driverId], references: [id])
  vehicle Vehicle       @relation(fields: [vehicleId], references: [id])

  assignedAt DateTime @default(now())

  @@unique([driverId, vehicleId])
}

model Route {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id])

  name      String
  direction String // MORNING / EVENING

  stops RouteStop[]
  trips Trip[]

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
}

model RouteStop {
  id      String @id @default(uuid())
  routeId String
  route   Route  @relation(fields: [routeId], references: [id])

  name      String
  latitude  Float
  longitude Float
  stopOrder Int

  students StudentRoute[]

  createdAt DateTime @default(now())

  @@unique([routeId, stopOrder])
}

model StudentRoute {
  id        String @id @default(uuid())
  studentId String
  stopId    String

  student Student   @relation(fields: [studentId], references: [id])
  stop    RouteStop @relation(fields: [stopId], references: [id])

  @@unique([studentId, stopId])
}

model Trip {
  id      String @id @default(uuid())
  routeId String
  route   Route  @relation(fields: [routeId], references: [id])

  driverId String
  driver   DriverProfile @relation(fields: [driverId], references: [id])

  startedAt DateTime?
  endedAt   DateTime?

  currentStopIndex Int? // ðŸ‘ˆ ADD THIS

  boardingLogs BoardingLog[]

  createdAt DateTime @default(now())
}

model BoardingLog {
  id        String @id @default(uuid())
  tripId    String
  studentId String

  trip    Trip    @relation(fields: [tripId], references: [id])
  student Student @relation(fields: [studentId], references: [id])

  eventType String // BOARD / DROP
  latitude  Float?
  longitude Float?
  timestamp DateTime @default(now())

  @@index([studentId])
}

model Attendance {
  id       String   @id @default(uuid())
  personId String
  date     DateTime
  status   String // PRESENT / ABSENT
  source   String // EVENT / MANUAL

  person Person @relation(fields: [personId], references: [id])

  createdAt DateTime @default(now())

  @@unique([personId, date])
}

model MovementEvent {
  id        String   @id @default(uuid())
  personId  String
  eventType String // ENTER_SCHOOL, EXIT_SCHOOL, BOARD_BUS, DROP_BUS
  source    String // SCHOOL_RFID, BUS_RFID
  location  String?
  timestamp DateTime @default(now())

  person Person @relation(fields: [personId], references: [id])

  @@index([personId, timestamp])
}

model Person {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  type  String // STUDENT | TEACHER | STAFF | SECURITY | DRIVER | HELPER
  refId String? // Student.id, DriverProfile.id, etc.

  rfidTag String @unique

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  attendance Attendance[]
  events     MovementEvent[]
  Student    Student[]
}
